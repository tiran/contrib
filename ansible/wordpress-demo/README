Based on http://www.severalnines.com/blog/wordpress-application-clustering-using-kubernetes-haproxy-and-keepalived

Changes:

 MySQL replication controller instead of plain MySQL pod
 NodePort service

Docker Registry
---------------

On master:
docker run -d -p 5000:5000 --restart=always -v /var/lib/docker-registry:/var/lib/registry -v /etc/kubernetes/certs:/certs:ro -e REGISTRY_HTTP_TLS_CERTIFICATE=/certs/server.crt -e REGISTRY_HTTP_TLS_KEY=/certs/server.key --name registry registry:2

On all nodes:
cp /etc/kubernetes/certs/ca.crt /etc/pki/ca-trust/source/anchors/
update-ca-trust extract
systemctl restart docker.service

Custodia setup
--------------

mkdir -p /var/lib/custodia /var/lib/custodia/client
cp gustodia /var/lib/custodia/client/go-custodia

modify example "custodia.conf"
set [global] server_socket = /var/lib/custodia/client/server_socket

curl --unix-socket /var/lib/custodia/client/server_socket \
    -H "REMOTE_USER: curl" \
    -X POST \
    http://localhost/secrets/wordpress/
curl --unix-socket /var/lib/custodia/client/server_socket \
    -H "REMOTE_USER: curl" \
    -H "Content-Type: application/json" \
    -X PUT \
    -d '{"type": "simple", "value": "yourpassword"}' \
    http://localhost/secrets/wordpress/db_password

